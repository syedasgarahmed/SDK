<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #ffffff;
            color: #000000;
            display: flex;
            flex-direction: column;
            padding-left: 20px;
            border-right: 1px solid rgb(224, 224, 224);
        }
        .sidebar h1 {
            font-size: 22px;
            margin-bottom: 30px;
            text-align: center;
        }
        .sidebar ul {
            list-style: none;
        }
        .sidebar ul li {
            margin: 15px 0;
            font-size: 16px;
        }
        .sidebar ul li a {
            color: #000000;
            text-decoration: none;
        }
        .sidebar ul li a:hover {
            text-decoration: underline;
        }
        .main-content {
            flex: 1;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 7vh;
            border-bottom: 1px solid rgb(212, 212, 212);
        }
        .header h2 {
            font-size: 24px;
        }
        .cards {
            display: grid;
            gap: 20px;
            padding: 20px 0;
        }
        .product-container {
            display: flex;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            align-items: flex-start;
        }
        .product-images {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-right: 20px;
        }
        .product-images img {
            width: 80px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            background: #fff;
        }
        .product-details {
            max-width: 400px;
        }
        h2 {
            font-size: 20px;
            font-weight: bold;
        }
        .rating {
            color: gold;
            font-size: 18px;
            margin: 5px 0;
        }
        .owner, .owner-email {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }
        .price {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .pay-btn {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .pay-btn:hover {
            background-color: #218838;
        }
        .payment-response {
            margin-top: 10px;
            font-size: 14px;
        }
        .payment-response div {
            margin-bottom: 5px;
        }
        .payment-response .nested {
            margin-left: 20px;
        }
    </style>
    <script src="http://localhost:5500/Unobfuscated_Ewallet.js"></script>
</head>
<body>
    <div class="sidebar">
        <h1 style="margin-top: 25px; margin-bottom: 5px;">CLIENT_APP</h1>
        <ul style="margin-top: 18px; border-top: 1px solid rgb(216, 216, 216);">
            <li><a href="login.html">Login</a></li>
            <li><a href="product.html">Products</a></li>
            <li><a href="dashboard.html">My eWallet (Embedded)</a></li>
        </ul>      
    </div>
    <div class="main-content">
        <div class="header">
            <h2>Dashboard</h2>
            <button 
                onclick="logoutWallet()"
                id="logoutButton"
                style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;"
            >
                Logout Wallet
            </button>
        </div>
        <div class="cards">
            <div class="product-container" 
                 data-price="100" 
                 data-description="Test T-shirt Product" 
                 data-currency="INR" 
                 data-product-id="product1" 
                 data-product-uid="prod-123456" 
                 data-owner="Sh

ashank" 
                 data-owner-email="shashank@bizionictech.com" 
                 data-tax-percentage="18.0" 
                 data-tax-description="Standard VAT" 
                 data-payment-type="CARD">
                <div class="product-images">
                    <img src="https://razorpay.com/build/browser/static/demo-tshirt.173097bd.svg" alt="T-shirt">
                </div>
                <div class="product-details">
                    <h2>T-shirt</h2>
                    <div class="rating">★★★★★</div>
                    <p class="owner">Sold by: Shashank</p>
                    <p class="owner-email">Email: shashank@bizionictech.com</p>
                    <p class="price">₹ 100</p>
                    <button class="pay-btn" onclick="openPaymentV1(event)">Pay with eWallet</button>
                    <div id="paymentResponse-product1" class="payment-response"></div>
                </div>
            </div>
            <div class="product-container" 
                 data-price="50" 
                 data-description="Test Hoodie Product" 
                 data-currency="USD" 
                 data-product-id="product2" 
                 data-product-uid="prod-789012" 
                 data-owner="ajaruddin" 
                 data-owner-email="ajaruddin@bizionictech.com" 
                 data-tax-percentage="18.0" 
                 data-tax-description="StandardVAT" 
                 data-payment-type="CARD">
                <div class="product-images">
                    <img src="https://razorpay.com/build/browser/static/demo-tshirt.173097bd.svg" alt="Hoodie">
                </div>
                <div class="product-details">
                    <h2>Hoodie</h2>
                    <div class="rating">★★★★☆</div>
                    <p class="owner">Sold by: ajaruddin</p>
                    <p class="owner-email">Email: ajaruddin@bizionictech.com</p>
                    <p class="price">$ 50</p>
                    <button class="pay-btn" onclick="openPaymentV1(event)">Pay with eWallet</button>
                    <div id="paymentResponse-product2" class="payment-response"></div>
                </div>
            </div>
            <div class="product-container" 
                 data-price="75" 
                 data-description="Test Cap Product" 
                 data-currency="AED" 
                 data-product-id="product3" 
                 data-product-uid="prod-345678" 
                 data-owner="Shashank" 
                 data-owner-email="shashank@bizionictech.com" 
                 data-tax-percentage="18.0" 
                 data-tax-description="Standard VAT" 
                 data-payment-type="CARD">
                <div class="product-images">
                    <img src="https://razorpay.com/build/browser/static/demo-tshirt.173097bd.svg" alt="Cap">
                </div>
                <div class="product-details">
                    <h2>Cap</h2>
                    <div class="rating">★★★★★</div>
                    <p class="owner">Sold by: Shashank</p>
                    <p class="owner-email">Email: shashank@bizionictech.com</p>
                    <p class="price">AED 75</p>
                    <button class="pay-btn" onclick="openPaymentV1(event)">Pay with eWallet</button>
                    <div id="paymentResponse-product3" class="payment-response"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const wallet = new Ewallet();
            const orderApiUrl = "https://dev-api.bizionictech.com/api/ewallet/order/create";
            const authToken = "Bearer 9b21427a-1118-4a3e-90c2-653afe88b1bc";

            function formatResponse(obj, level = 0) {
                let html = '';
                const indent = ' '.repeat(level * 20);
                for (const [key, value] of Object.entries(obj)) {
                    const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim();
                    if (value && typeof value === 'object' && !Array.isArray(value)) {
                        html += `<div class="nested">${indent}${formattedKey}:<br>`;
                        html += formatResponse(value, level + 1);
                        html += `</div>`;
                    } else {
                        html += `<div class="nested">${indent}${formattedKey}: ${value ?? 'N/A'}</div>`;
                    }
                }
                return html;
            }

            function displayPaymentResponse(type, response, productId) {
                const responseContainer = document.getElementById(`paymentResponse-${productId}`);
                if (!responseContainer) {
                    console.error(`Payment response container not found for productId: ${productId}`);
                    return;
                }

                responseContainer.style.display = 'block';

                if (type === 'success') {
                    const currencyMap = { 1: 'INR', 2: 'AED', 3: 'USD' };
                    const currencySymbolMap = { 'INR': '₹', 'AED': 'AED', 'USD': '$' };
                    const currencyId = response.order?.product?.currencyId || 2;
                    const currencyCode = currencyMap[currencyId] || 'AED';
                    const currencySymbol = currencySymbolMap[currencyCode] || 'AED';

                    const modifiedResponse = JSON.parse(JSON.stringify(response));
                    if (modifiedResponse.order?.product) {
                        modifiedResponse.order.product.baseAmount = `${currencySymbol} ${modifiedResponse.order.product.baseAmount}`;
                        modifiedResponse.order.product.taxAmount = `${currencySymbol} ${modifiedResponse.order.product.taxAmount}`;
                        modifiedResponse.order.product.platformFeeAmount = `${currencySymbol} ${modifiedResponse.order.product.platformFeeAmount}`;
                        modifiedResponse.order.product.merchantFeeAmount = `${currencySymbol} ${modifiedResponse.order.product.merchantFeeAmount}`;
                        modifiedResponse.order.product.totalAmount = `${currencySymbol} ${modifiedResponse.order.product.totalAmount}`;
                        modifiedResponse.order.product.currencyId = currencyCode;
                    }

                    responseContainer.innerHTML = `
                        <div style="color: green; font-weight: bold;">
                            ${response.message || 'Payment Successful!'}
                        </div>
                        <div>
                            ${formatResponse(modifiedResponse)}
                        </div>
                    `;
                } else {
                    responseContainer.innerHTML = `
                        <div style="color: red; font-weight: bold;">
                            Payment Failed!
                        </div>
                        <div>
                            Error: ${response.error || response.message || 'Unknown error'}
                        </div>
                    `;
                }
            }

            async function createOrderForProduct(productContainer) {
                const payload = {
                    productUId: productContainer.dataset.productUid,
                    productTitle: productContainer.querySelector("h2").textContent,
                    productDescription: productContainer.dataset.description,
                    productOwnerEmail: productContainer.dataset.ownerEmail,
                    taxPercentage: parseFloat(productContainer.dataset.taxPercentage),
                    taxDescription: productContainer.dataset.taxDescription,
                    productBaseAmount: parseFloat(productContainer.dataset.price),
                    productAmountCurrencyCode: productContainer.dataset.currency,
                    paymentType: productContainer.dataset.paymentType,
                    clientId: "LocalEarnOn",
                    clientSecret: "HQefo4XlUXKwElOCaLFqlMJMZ8JBgIF48f7SKm"
                };

                try {
                    const response = await fetch(orderApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Order creation failed: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data.orderId;
                } catch (error) {
                    throw new Error(`Order creation error: ${error.message}`);
                }
            }

            async function openPaymentV1(event) {
                const productContainer = event.target.closest(".product-container");
                const productId = productContainer.dataset.productId;
                const responseContainer = document.getElementById(`paymentResponse-${productId}`);
                responseContainer.style.display = 'none';

                try {
                    const orderId = await createOrderForProduct(productContainer);
                    const token = "f6f8be62-d0e6-4ae3-868c-3438bf60821c";

                    await wallet.openPayWindowV1({
                        orderId,
                        token,
                        onSuccess: (data) => {
                            displayPaymentResponse('success', data, productId);
                        },
                        onError: (error) => {
                            displayPaymentResponse('error', error, productId);
                        },
                        onProcessing: (message) => {
                            responseContainer.innerHTML = `
                                <div style="color: blue; font-weight: bold;">
                                    Processing Payment...
                                </div>
                                <div>
                                    ${message}
                                </div>
                            `;
                        }
                    });
                } catch (error) {
                    console.error('Payment failed:', error);
                    displayPaymentResponse('error', { message: error.message }, productId);
                }
            }

            function logoutWallet() {
                wallet.logout();
            }

            window.openPaymentV1 = openPaymentV1;
            window.logoutWallet = logoutWallet;
        });
    </script>
</body>
</html>